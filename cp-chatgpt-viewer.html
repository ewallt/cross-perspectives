<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cross Perspectives</title>
    <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
    <style>
        :root {
            --bg: #0f172a;
            --bg-alt: #020617;
            --panel: #020617;
            --panel-alt: #020617;
            --panel-soft: #020617;
            --card: #020617;
            --card-soft: #020617;
            --border-subtle: rgba(148, 163, 184, 0.25);
            --border-strong: rgba(148, 163, 184, 0.5);
            --accent: #38bdf8;
            --accent-soft: rgba(56, 189, 248, 0.12);
            --accent-strong: rgba(56, 189, 248, 0.28);
            --accent-muted: rgba(56, 189, 248, 0.65);
            --accent-secondary: #a855f7;
            --text: #e5e7eb;
            --text-soft: #9ca3af;
            --text-softer: #6b7280;
            --danger: #f97373;
            --tag-bg: rgba(15, 23, 42, 0.9);
            --chip-bg: rgba(15, 23, 42, 0.9);
            --chip-border: rgba(148, 163, 184, 0.4);
            --chip-active-bg: rgba(56, 189, 248, 0.12);
            --chip-active-border: #38bdf8;
            --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.9);
            --shadow-card: 0 16px 38px rgba(15, 23, 42, 0.9);
            --radius-lg: 18px;
            --radius-xl: 22px;
            --radius-full: 999px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            background: radial-gradient(circle at top, #0b1120 0, #020617 45%, #000 100%);
            color: var(--text);
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        .app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header.app-header {
            position: sticky;
            top: 0;
            z-index: 20;
            backdrop-filter: blur(26px);
            background: linear-gradient(to bottom, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.88));
            border-bottom: 1px solid rgba(148, 163, 184, 0.18);
            padding: 1rem 1.25rem 0.85rem;
        }

        .header-inner {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 1.25rem;
        }

        .header-title-group {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }

        .app-title-row {
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .app-pill {
            padding: 0.16rem 0.6rem 0.18rem;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.35);
            font-size: 0.7rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-soft);
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.18), rgba(15, 23, 42, 0.9));
        }

        .app-pill-dot {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 999px;
            background: var(--accent);
            box-shadow: 0 0 8px rgba(56, 189, 248, 0.8);
        }

        h1.app-title {
            margin: 0;
            font-size: 1.28rem;
            font-weight: 600;
            letter-spacing: 0.02em;
            display: flex;
            align-items: baseline;
            gap: 0.55rem;
        }

        .app-title span.highlight {
            background: linear-gradient(120deg, #38bdf8, #a855f7, #22c55e);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .app-subtitle {
            margin: 0;
            font-size: 0.85rem;
            color: var(--text-soft);
        }

        .header-stats {
            display: flex;
            align-items: center;
            gap: 0.85rem;
            font-size: 0.78rem;
            color: var(--text-soft);
        }

        .header-stat-pill {
            padding: 0.4rem 0.6rem;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            background: radial-gradient(circle at top, rgba(15, 23, 42, 0.8), rgba(15, 23, 42, 0.95));
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            box-shadow: 0 12px 28px rgba(15, 23, 42, 0.75);
        }

        .header-stat-pill strong {
            font-weight: 600;
            color: var(--accent);
        }

        .header-stat-label {
            color: var(--text-soft);
        }

        .header-active-filters {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.18rem 0.5rem;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.35);
            white-space: nowrap;
            max-width: 260px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .header-active-filters span {
            font-size: 0.72rem;
        }

        main.layout {
            flex: 1;
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            padding: 1.1rem 1.25rem 1.4rem;
            display: grid;
            grid-template-columns: minmax(260px, 300px) minmax(0, 1.1fr) minmax(0, 1.5fr);
            gap: 1rem;
        }

        aside.sidebar {
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 1), rgba(2, 6, 23, 0.98));
            border-radius: var(--radius-xl);
            padding: 0.75rem 0.8rem 0.9rem;
            border: 1px solid rgba(148, 163, 184, 0.18);
            box-shadow: var(--shadow-soft);
            display: flex;
            flex-direction: column;
            gap: 0.7rem;
        }

        .sidebar-section {
            padding: 0.35rem 0.4rem 0.45rem;
            border-radius: 16px;
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.98));
            border: 1px solid rgba(30, 64, 175, 0.6);
        }

        .sidebar-section + .sidebar-section {
            margin-top: 0.35rem;
        }

        .sidebar-heading {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.4rem;
            margin-bottom: 0.3rem;
        }

        .sidebar-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--text-softer);
        }

        .sidebar-heading-badge {
            font-size: 0.7rem;
            padding: 0.08rem 0.45rem;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.35);
            color: var(--text-softer);
        }

        .search-row {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            margin-bottom: 0.35rem;
        }

        .search-input-wrap {
            position: relative;
            flex: 1;
        }

        .search-input {
            width: 100%;
            padding: 0.45rem 0.75rem 0.47rem 1.8rem;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 1));
            color: var(--text);
            font-size: 0.82rem;
            outline: none;
        }

        .search-input::placeholder {
            color: var(--text-softer);
        }

        .search-icon {
            position: absolute;
            left: 0.68rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.9rem;
            color: var(--text-softer);
        }

        .clear-btn {
            border: 1px solid rgba(148, 163, 184, 0.45);
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 1));
            color: var(--text-soft);
            border-radius: 999px;
            padding: 0.38rem 0.7rem;
            font-size: 0.74rem;
            display: inline-flex;
            align-items: center;
            gap: 0.28rem;
            cursor: pointer;
            white-space: nowrap;
        }

        .clear-btn:hover {
            border-color: rgba(248, 250, 252, 0.8);
            color: #e5e7eb;
        }

        .sort-row {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            margin-top: 0.2rem;
        }

        .sort-row label {
            font-size: 0.75rem;
            color: var(--text-softer);
        }

        .sort-select {
            flex: 1;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.45);
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 1));
            color: var(--text-soft);
            font-size: 0.78rem;
            padding: 0.35rem 0.7rem 0.35rem 0.7rem;
            outline: none;
        }

        .chip-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
        }

        .chip-scroll {
            max-height: 160px;
            overflow: auto;
            padding-right: 0.1rem;
        }

        .chip {
            border-radius: 999px;
            border: 1px solid var(--chip-border);
            padding: 0.26rem 0.7rem 0.28rem;
            font-size: 0.74rem;
            color: var(--text-soft);
            background: var(--chip-bg);
            cursor: pointer;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            transition: border-color 0.1s ease, background 0.1s ease, color 0.1s ease, transform 0.05s ease;
        }

        .chip:hover {
            border-color: var(--accent-muted);
            color: #e5e7eb;
        }

        .chip--active {
            background: var(--chip-active-bg);
            border-color: var(--chip-active-border);
            color: #e5e7eb;
            box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.3);
        }

        .chip-dot {
            width: 6px;
            height: 6px;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.85);
        }

        .chip--active .chip-dot {
            background: var(--accent);
        }

        .chip-label-main {
            max-width: 130px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chip-label-count {
            font-size: 0.72rem;
            color: var(--text-softer);
        }

        .sidebar-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 0.3rem;
        }

        .stat-card {
            padding: 0.4rem 0.4rem 0.45rem;
            border-radius: 14px;
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 1), rgba(15, 23, 42, 0.94));
            border: 1px solid rgba(15, 23, 42, 1);
            text-align: left;
        }

        .stat-label {
            display: block;
            font-size: 0.68rem;
            color: var(--text-softer);
            margin-bottom: 0.05rem;
        }

        .stat-value {
            display: flex;
            align-items: baseline;
            gap: 0.25rem;
        }

        .stat-value-main {
            font-size: 0.92rem;
            font-weight: 600;
            color: var(--accent);
        }

        .stat-value-sub {
            font-size: 0.7rem;
            color: var(--text-softer);
        }

        .stat-secondary-row {
            margin-top: 0.25rem;
            font-size: 0.68rem;
            color: var(--text-softer);
        }

        .list-panel {
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.96));
            border-radius: var(--radius-xl);
            border: 1px solid rgba(30, 64, 175, 0.7);
            box-shadow: var(--shadow-card);
            padding: 0.6rem 0.6rem 0.7rem;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .list-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.4rem;
            margin-bottom: 0.45rem;
        }

        .list-title {
            font-size: 0.78rem;
            text-transform: uppercase;
            letter-spacing: 0.14em;
            color: var(--text-softer);
        }

        .list-subtitle {
            font-size: 0.72rem;
            color: var(--text-softer);
        }

        .list-header-right {
            font-size: 0.72rem;
            color: var(--text-softer);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .list-counter-pill {
            padding: 0.16rem 0.5rem;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.4);
            display: inline-flex;
            align-items: center;
            gap: 0.16rem;
        }

        .list-counter-pill strong {
            color: #e5e7eb;
        }

        .insight-list {
            margin: 0;
            padding: 0;
            list-style: none;
            flex: 1;
            overflow: auto;
            border-radius: 18px;
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 1), rgba(15, 23, 42, 0.98));
            border: 1px solid rgba(15, 23, 42, 1);
        }

        .insight-empty {
            padding: 1.2rem 1rem;
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-soft);
        }

        .insight-card {
            padding: 0.7rem 0.8rem 0.72rem;
            border-bottom: 1px solid rgba(15, 23, 42, 1);
            cursor: pointer;
            background: transparent;
            transition: background 0.08s ease, transform 0.04s ease, box-shadow 0.08s ease;
        }

        .insight-card:last-child {
            border-bottom: none;
        }

        .insight-card:hover {
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.9));
        }

        .insight-card--selected {
            background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.12), rgba(15, 23, 42, 1));
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.8);
        }

        .insight-card__title {
            font-size: 0.9rem;
            margin: 0 0 0.15rem;
            font-weight: 600;
            color: #e5e7eb;
        }

        .insight-card__meta {
            font-size: 0.72rem;
            color: var(--text-softer);
            display: flex;
            align-items: center;
            gap: 0.4rem;
            margin-bottom: 0.28rem;
        }

        .meta-dot {
            width: 3px;
            height: 3px;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.7);
        }

        .insight-card__text {
            font-size: 0.78rem;
            color: var(--text-soft);
            margin: 0 0 0.3rem;
        }

        .insight-card__tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
        }

        .tag {
            font-size: 0.68rem;
            padding: 0.14rem 0.5rem 0.16rem;
            border-radius: 999px;
            background: var(--tag-bg);
            border: 1px solid rgba(148, 163, 184, 0.4);
            color: var(--text-softer);
        }

        .detail-panel {
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.99), rgba(15, 23, 42, 0.97));
            border-radius: var(--radius-xl);
            border: 1px solid rgba(129, 140, 248, 0.65);
            box-shadow: var(--shadow-card);
            padding: 0.7rem 0.75rem 0.85rem;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .detail-header {
            margin-bottom: 0.45rem;
        }

        .detail-section-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.14em;
            color: var(--text-softer);
            margin-bottom: 0.15rem;
        }

        .detail-title {
            font-size: 1rem;
            margin: 0 0 0.22rem;
            font-weight: 600;
            letter-spacing: 0.01em;
        }

        .detail-meta-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.4rem;
            margin-bottom: 0.35rem;
        }

        .detail-meta-main {
            font-size: 0.8rem;
            color: var(--text-soft);
            display: flex;
            align-items: center;
            gap: 0.45rem;
        }

        .detail-meta-main strong {
            color: #e5e7eb;
        }

        .detail-actions {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .detail-pill-btn {
            font-size: 0.72rem;
            padding: 0.18rem 0.55rem;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.45);
            background: rgba(15, 23, 42, 0.98);
            color: var(--text-soft);
            display: inline-flex;
            align-items: center;
            gap: 0.26rem;
            cursor: pointer;
            white-space: nowrap;
        }

        .detail-pill-btn span.dot {
            width: 6px;
            height: 6px;
            border-radius: 999px;
            background: var(--accent);
        }

        .detail-pill-btn:hover {
            border-color: rgba(248, 250, 252, 0.9);
            color: #e5e7eb;
        }

        .detail-tags-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            margin-bottom: 0.35rem;
        }

        .detail-tag-link {
            font-size: 0.7rem;
            padding: 0.18rem 0.6rem 0.2rem;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.45);
            background: rgba(15, 23, 42, 0.96);
            color: var(--text-softer);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .detail-tag-link:hover {
            border-color: var(--accent);
            color: #e5e7eb;
        }

        .detail-tag-link span.dot {
            width: 6px;
            height: 6px;
            border-radius: 999px;
            background: rgba(129, 140, 248, 0.9);
        }

        .detail-main-layout {
            flex: 1;
            display: grid;
            grid-template-columns: minmax(0, 2.1fr) minmax(260px, 1.4fr);
            gap: 0.9rem;
            min-height: 0;
        }

        .detail-body {
            border-radius: 18px;
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 1), rgba(15, 23, 42, 0.98));
            border: 1px solid rgba(15, 23, 42, 1);
            font-size: 0.86rem;
            line-height: 1.6;
            color: var(--text);
            white-space: pre-wrap;
            padding: 0.6rem 0.7rem 0.8rem;
            overflow: auto;
            min-height: 0;
        }

        .detail-empty {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-soft);
            padding: 1.3rem 0.7rem;
        }

        .related-section {
            border-radius: 18px;
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 1), rgba(15, 23, 42, 0.98));
            border: 1px solid rgba(15, 23, 42, 1);
            padding: 0.55rem 0.6rem 0.7rem;
            min-height: 0;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .related-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.4rem;
            margin-bottom: 0.1rem;
        }

        .related-title {
            font-size: 0.78rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--text-softer);
        }

        .related-list {
            list-style: none;
            margin: 0;
            padding: 0;
            display: grid;
            grid-template-columns: minmax(0, 1fr);
            gap: 0.25rem;
            overflow: auto;
        }

        .related-item {
            font-size: 0.78rem;
            padding: 0.32rem 0.5rem 0.34rem;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.96);
            border: 1px solid rgba(148, 163, 184, 0.4);
            color: var(--text-soft);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.4rem;
            cursor: pointer;
        }

        .related-item:hover {
            border-color: var(--accent);
            color: #e5e7eb;
        }

        .related-main {
            display: flex;
            flex-direction: column;
            gap: 0.02rem;
        }

        .related-title-text {
            max-width: 220px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .related-meta {
            font-size: 0.7rem;
            color: var(--text-softer);
        }

        .related-pill {
            font-size: 0.68rem;
            padding: 0.12rem 0.35rem;
            border-radius: 999px;
            border: 1px solid rgba(56, 189, 248, 0.6);
            color: var(--accent-muted);
            background: rgba(8, 47, 73, 0.4);
            white-space: nowrap;
        }

        @media (max-width: 1200px) {
            main.layout {
                grid-template-columns: minmax(250px, 280px) minmax(0, 1fr) minmax(0, 1.2fr);
            }
        }

        @media (max-width: 1100px) {
            main.layout {
                grid-template-columns: minmax(230px, 260px) minmax(0, 1fr);
                grid-template-rows: auto minmax(0, 1fr);
                grid-template-areas:
                    "sidebar sidebar"
                    "list detail";
            }

            aside.sidebar {
                grid-area: sidebar;
                flex-direction: row;
                align-items: stretch;
                gap: 0.7rem;
            }

            .sidebar-section {
                flex: 1;
            }

            .list-panel {
                grid-area: list;
            }

            .detail-panel {
                grid-area: detail;
            }
        }

        @media (max-width: 960px) {
            .detail-main-layout {
                grid-template-columns: minmax(0, 1fr);
            }
        }

        @media (max-width: 860px) {
            header.app-header {
                padding: 0.9rem 0.9rem 0.75rem;
            }

            main.layout {
                padding: 0.9rem 0.9rem 1.1rem;
                grid-template-columns: minmax(0, 1fr);
                grid-template-areas:
                    "sidebar"
                    "list"
                    "detail";
            }

            aside.sidebar {
                flex-direction: column;
            }

            .header-inner {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-stats {
                width: 100%;
                justify-content: space-between;
            }

            .detail-panel {
                margin-top: 0.35rem;
            }
        }

        @media (max-width: 540px) {
            .header-stats {
                flex-wrap: wrap;
                gap: 0.35rem;
            }

            .list-panel {
                padding: 0.55rem 0.5rem 0.65rem;
            }

            .detail-panel {
                padding: 0.55rem 0.55rem 0.8rem;
            }
        }
    </style>
</head>
<body>
<div class="app">
    <header class="app-header">
        <div class="header-inner">
            <div class="header-title-group">
                <div class="app-title-row">
                    <div class="app-pill">
                        <span class="app-pill-dot"></span>
                        <span>Perspective Explorer</span>
                    </div>
                </div>
                <h1 class="app-title">
                    <span class="highlight">Cross Perspectives</span>
                    <span>¬∑ theological insight atlas</span>
                </h1>
                <p class="app-subtitle">
                    Browse voices, follow themes, and read the cross from many angles in a single, woven view.
                </p>
            </div>
            <div class="header-stats">
                <div class="header-stat-pill">
                    <span class="header-stat-label">Insights</span>
                    <strong id="statsTotal">‚Äì</strong>
                </div>
                <div class="header-stat-pill">
                    <span class="header-stat-label">Voices</span>
                    <strong id="statsVoices">‚Äì</strong>
                </div>
                <div class="header-stat-pill">
                    <span class="header-stat-label">Topics</span>
                    <strong id="statsTags">‚Äì</strong>
                </div>
                <div class="header-active-filters">
                    <span>Now viewing:</span>
                    <span id="activeFiltersSummary">All voices ¬∑ All topics</span>
                </div>
            </div>
        </div>
    </header>

    <main class="layout">
        <aside class="sidebar">
            <section class="sidebar-section">
                <div class="sidebar-heading">
                    <div>
                        <div class="sidebar-title">Search &amp; Sort</div>
                    </div>
                    <div class="sidebar-heading-badge">Reader controls</div>
                </div>
                <div class="search-row">
                    <div class="search-input-wrap">
                        <span class="search-icon">üîç</span>
                        <input id="searchInput" class="search-input" placeholder="Search title, text, or voice">
                    </div>
                    <button id="clearFilters" class="clear-btn" type="button">
                        ‚úï Clear
                    </button>
                </div>
                <div class="sort-row">
                    <label for="sortSelect">Order</label>
                    <select id="sortSelect" class="sort-select">
                        <option value="newest">Newest first</option>
                        <option value="oldest">Oldest first</option>
                        <option value="title">By title</option>
                        <option value="voice">By voice</option>
                    </select>
                </div>
            </section>

            <section class="sidebar-section">
                <div class="sidebar-heading">
                    <div>
                        <div class="sidebar-title">Voices</div>
                    </div>
                    <div class="sidebar-heading-badge">Click to focus</div>
                </div>
                <div id="voiceChips" class="chip-group chip-scroll"></div>
            </section>

            <section class="sidebar-section">
                <div class="sidebar-heading">
                    <div>
                        <div class="sidebar-title">Topics</div>
                    </div>
                    <div class="sidebar-heading-badge">Mix &amp; match</div>
                </div>
                <div id="tagChips" class="chip-group chip-scroll"></div>
            </section>

            <section class="sidebar-section">
                <div class="sidebar-heading">
                    <div class="sidebar-title">Collection glance</div>
                </div>
                <div class="sidebar-stats-grid">
                    <div class="stat-card">
                        <span class="stat-label">Visible</span>
                        <div class="stat-value">
                            <span id="statsVisible" class="stat-value-main">‚Äì</span>
                            <span class="stat-value-sub">now</span>
                        </div>
                        <div class="stat-secondary-row">
                            Filtered by your current view.
                        </div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">Voices</span>
                        <div class="stat-value">
                            <span id="statsVoicesSmall" class="stat-value-main">‚Äì</span>
                            <span class="stat-value-sub">distinct</span>
                        </div>
                        <div class="stat-secondary-row">
                            Each voice a lens on the cross.
                        </div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">Topics</span>
                        <div class="stat-value">
                            <span id="statsTagsSmall" class="stat-value-main">‚Äì</span>
                            <span class="stat-value-sub">themes</span>
                        </div>
                        <div class="stat-secondary-row">
                            Combine tags to follow threads.
                        </div>
                    </div>
                </div>
            </section>
        </aside>

        <section class="list-panel">
            <div class="list-header">
                <div>
                    <div class="list-title">Insights</div>
                    <div class="list-subtitle">Click a card to open the full perspective.</div>
                </div>
            <div class="list-header-right">
                    <div class="list-counter-pill">
                        <span>Showing</span>
                        <strong id="listCount">‚Äì</strong>
                    </div>
                </div>
            </div>
            <ul id="insightList" class="insight-list">
                <li class="insight-empty">Loading insights‚Ä¶</li>
            </ul>
        </section>

        <section class="detail-panel">
            <div id="detailContent" class="detail-empty">
                Choose a voice and topic on the left, then select an insight card to begin reading.
            </div>
        </section>
    </main>
</div>

<script>
    class CrossStore {
        constructor() {
            this.db = new Dexie("CrossPerspectivesDB");
            this.db.version(1).stores({
                insights: '++id, voice, title, *tags, created_at'
            });
        }
        async init() {
            if (!this.db.isOpen()) await this.db.open();
        }
        async getAll() {
            return await this.db.insights
                .orderBy('created_at')
                .reverse()
                .toArray();
        }
    }

    const store = new CrossStore();

    let allInsights = [];
    let filteredInsights = [];
    let allVoices = [];
    let allTags = [];
    const selectedVoices = new Set();
    const selectedTags = new Set();
    let searchQuery = '';
    let sortMode = 'newest';
    let selectedInsightId = null;

    function truncate(text, maxLength) {
        if (!text) return '';
        if (text.length <= maxLength) return text;
        return text.slice(0, maxLength - 1) + '‚Ä¶';
    }

    function formatDate(isoString) {
        if (!isoString) return '';
        const date = new Date(isoString);
        if (isNaN(date.getTime())) return '';
        return date.toLocaleDateString(undefined, {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    }

    function setupEventHandlers() {
        const searchInput = document.getElementById('searchInput');
        const sortSelect = document.getElementById('sortSelect');
        const clearBtn = document.getElementById('clearFilters');

        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                searchQuery = e.target.value || '';
                applyFilters();
            });
        }

        if (sortSelect) {
            sortSelect.addEventListener('change', (e) => {
                sortMode = e.target.value;
                applyFilters();
            });
        }

        if (clearBtn) {
            clearBtn.addEventListener('click', () => {
                selectedVoices.clear();
                selectedTags.clear();
                searchQuery = '';
                sortMode = 'newest';
                const searchEl = document.getElementById('searchInput');
                if (searchEl) searchEl.value = '';
                const sortEl = document.getElementById('sortSelect');
                if (sortEl) sortEl.value = 'newest';
                renderFilterChips();
                applyFilters();
            });
        }
    }

    function renderFilterChips() {
        const voiceContainer = document.getElementById('voiceChips');
        const tagContainer = document.getElementById('tagChips');

        if (voiceContainer) {
            voiceContainer.innerHTML = '';
            allVoices.forEach((voice) => {
                const count = allInsights.filter(i => i.voice === voice).length;
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'chip' + (selectedVoices.has(voice) ? ' chip--active' : '');
                const dot = document.createElement('span');
                dot.className = 'chip-dot';
                const label = document.createElement('span');
                label.className = 'chip-label-main';
                label.textContent = voice || 'Unknown';
                const countSpan = document.createElement('span');
                countSpan.className = 'chip-label-count';
                countSpan.textContent = count;
                btn.appendChild(dot);
                btn.appendChild(label);
                btn.appendChild(countSpan);
                btn.addEventListener('click', () => {
                    if (selectedVoices.has(voice)) {
                        selectedVoices.delete(voice);
                    } else {
                        selectedVoices.add(voice);
                    }
                    renderFilterChips();
                    applyFilters();
                });
                voiceContainer.appendChild(btn);
            });
        }

        if (tagContainer) {
            tagContainer.innerHTML = '';
            allTags.forEach((tag) => {
                const count = allInsights.filter(i =>
                    Array.isArray(i.tags) && i.tags.includes(tag)
                ).length;
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'chip' + (selectedTags.has(tag) ? ' chip--active' : '');
                const dot = document.createElement('span');
                dot.className = 'chip-dot';
                const label = document.createElement('span');
                label.className = 'chip-label-main';
                label.textContent = tag;
                const countSpan = document.createElement('span');
                countSpan.className = 'chip-label-count';
                countSpan.textContent = count;
                btn.appendChild(dot);
                btn.appendChild(label);
                btn.appendChild(countSpan);
                btn.addEventListener('click', () => {
                    if (selectedTags.has(tag)) {
                        selectedTags.delete(tag);
                    } else {
                        selectedTags.add(tag);
                    }
                    renderFilterChips();
                    applyFilters();
                });
                tagContainer.appendChild(btn);
            });
        }
    }

    function applyFilters() {
        let result = allInsights.slice();

        if (selectedVoices.size > 0) {
            result = result.filter(insight => selectedVoices.has(insight.voice));
        }

        if (selectedTags.size > 0) {
            result = result.filter(insight =>
                Array.isArray(insight.tags) &&
                insight.tags.some(tag => selectedTags.has(tag))
            );
        }

        if (searchQuery && searchQuery.trim().length > 0) {
            const q = searchQuery.toLowerCase();
            result = result.filter(insight => {
                const text = `${insight.title || ''} ${insight.text || ''} ${insight.voice || ''}`.toLowerCase();
                return text.includes(q);
            });
        }

        switch (sortMode) {
            case 'oldest':
                result.sort((a, b) => {
                    const da = new Date(a.created_at).getTime();
                    const db = new Date(b.created_at).getTime();
                    return da - db;
                });
                break;
            case 'title':
                result.sort((a, b) => {
                    const ta = (a.title || '').toLowerCase();
                    const tb = (b.title || '').toLowerCase();
                    if (ta < tb) return -1;
                    if (ta > tb) return 1;
                    const da = new Date(a.created_at).getTime();
                    const db = new Date(b.created_at).getTime();
                    return db - da;
                });
                break;
            case 'voice':
                result.sort((a, b) => {
                    const va = (a.voice || '').toLowerCase();
                    const vb = (b.voice || '').toLowerCase();
                    if (va < vb) return -1;
                    if (va > vb) return 1;
                    const da = new Date(a.created_at).getTime();
                    const db = new Date(b.created_at).getTime();
                    return db - da;
                });
                break;
            case 'newest':
            default:
                result.sort((a, b) => {
                    const da = new Date(a.created_at).getTime();
                    const db = new Date(b.created_at).getTime();
                    return db - da;
                });
                break;
        }

        filteredInsights = result;
        renderList();
        renderStats();
        if (!selectedInsightId && filteredInsights.length > 0) {
            selectInsight(filteredInsights[0].id);
        } else if (selectedInsightId) {
            const stillVisible = filteredInsights.some(i => i.id === selectedInsightId);
            if (!stillVisible && filteredInsights.length > 0) {
                selectInsight(filteredInsights[0].id);
            }
            highlightSelectedCard();
        }
    }

    function renderStats() {
        const totalEl = document.getElementById('statsTotal');
        const voicesEl = document.getElementById('statsVoices');
        const tagsEl = document.getElementById('statsTags');
        const visibleEl = document.getElementById('statsVisible');
        const voicesSmallEl = document.getElementById('statsVoicesSmall');
        const tagsSmallEl = document.getElementById('statsTagsSmall');
        const listCountEl = document.getElementById('listCount');
        const summaryEl = document.getElementById('activeFiltersSummary');

        const total = allInsights.length;
        const totalVoices = allVoices.length;
        const totalTags = allTags.length;
        const visible = filteredInsights.length;

        if (totalEl) totalEl.textContent = total || '0';
        if (voicesEl) voicesEl.textContent = totalVoices || '0';
        if (tagsEl) tagsEl.textContent = totalTags || '0';
        if (visibleEl) visibleEl.textContent = visible || '0';
        if (voicesSmallEl) voicesSmallEl.textContent = totalVoices || '0';
        if (tagsSmallEl) tagsSmallEl.textContent = totalTags || '0';
        if (listCountEl) listCountEl.textContent = visible || '0';

        if (summaryEl) {
            const voicePart = selectedVoices.size > 0
                ? `Voices: ${Array.from(selectedVoices).slice(0, 2).join(', ')}${selectedVoices.size > 2 ? '‚Ä¶' : ''}`
                : 'All voices';
            const tagPart = selectedTags.size > 0
                ? `Topics: ${Array.from(selectedTags).slice(0, 2).join(', ')}${selectedTags.size > 2 ? '‚Ä¶' : ''}`
                : 'All topics';
            summaryEl.textContent = `${voicePart} ¬∑ ${tagPart}`;
        }
    }

    function renderList() {
        const list = document.getElementById('insightList');
        if (!list) return;
        list.innerHTML = '';

        if (!filteredInsights.length) {
            const empty = document.createElement('li');
            empty.className = 'insight-empty';
            empty.textContent = 'No insights match your current filters. Try clearing filters or changing search.';
            list.appendChild(empty);
            const detail = document.getElementById('detailContent');
            if (detail) {
                detail.innerHTML = '';
                const emptyDetail = document.createElement('div');
                emptyDetail.className = 'detail-empty';
                emptyDetail.textContent = 'No insight selected. Adjust your filters or search to bring perspectives into view.';
                detail.appendChild(emptyDetail);
            }
            return;
        }

        filteredInsights.forEach((insight) => {
            const li = document.createElement('li');
            const card = document.createElement('article');
            card.className = 'insight-card';
            card.dataset.id = String(insight.id);

            const titleEl = document.createElement('h3');
            titleEl.className = 'insight-card__title';
            titleEl.textContent = insight.title || '(Untitled insight)';

            const metaRow = document.createElement('div');
            metaRow.className = 'insight-card__meta';
            const voiceSpan = document.createElement('span');
            voiceSpan.textContent = insight.voice || 'Unknown voice';
            const dot = document.createElement('span');
            dot.className = 'meta-dot';
            const dateSpan = document.createElement('span');
            dateSpan.textContent = formatDate(insight.created_at);
            metaRow.appendChild(voiceSpan);
            metaRow.appendChild(dot);
            metaRow.appendChild(dateSpan);

            const textEl = document.createElement('p');
            textEl.className = 'insight-card__text';
            textEl.textContent = truncate(insight.text || '', 220);

            const tagsRow = document.createElement('div');
            tagsRow.className = 'insight-card__tags';
            if (Array.isArray(insight.tags) && insight.tags.length > 0) {
                insight.tags.forEach((tag) => {
                    const span = document.createElement('span');
                    span.className = 'tag';
                    span.textContent = tag;
                    tagsRow.appendChild(span);
                });
            }

            card.appendChild(titleEl);
            card.appendChild(metaRow);
            card.appendChild(textEl);
            card.appendChild(tagsRow);

            card.addEventListener('click', () => {
                selectInsight(insight.id);
            });

            li.appendChild(card);
            list.appendChild(li);
        });

        highlightSelectedCard();
    }

    function selectInsight(id) {
        selectedInsightId = id;
        const insight = allInsights.find(i => i.id === id);
        renderDetail(insight);
        highlightSelectedCard();
    }

    function highlightSelectedCard() {
        const cards = document.querySelectorAll('.insight-card');
        cards.forEach(card => {
            if (String(card.dataset.id) === String(selectedInsightId)) {
                card.classList.add('insight-card--selected');
            } else {
                card.classList.remove('insight-card--selected');
            }
        });
    }

    function getRelatedInsights(insight, maxCount = 6) {
        if (!insight) return [];
        const currentId = insight.id;
        const baseTags = Array.isArray(insight.tags) ? insight.tags : [];

        const scored = allInsights
            .filter(other => other.id !== currentId)
            .map(other => {
                let score = 0;
                if (other.voice === insight.voice) score += 2;
                const otherTags = Array.isArray(other.tags) ? other.tags : [];
                const sharedTags = otherTags.filter(t => baseTags.includes(t));
                score += sharedTags.length;
                return { insight: other, score, sharedTags };
            })
            .filter(item => item.score > 0);

        scored.sort((a, b) => {
            if (b.score !== a.score) return b.score - a.score;
            const da = new Date(a.insight.created_at).getTime();
            const db = new Date(b.insight.created_at).getTime();
            return db - da;
        });

        return scored.slice(0, maxCount);
    }

    function renderDetail(insight) {
        const container = document.getElementById('detailContent');
        if (!container) return;
        container.innerHTML = '';

        if (!insight) {
            const empty = document.createElement('div');
            empty.className = 'detail-empty';
            empty.textContent = 'Select an insight from the list to see its full perspective.';
            container.appendChild(empty);
            return;
        }

        const header = document.createElement('div');
        header.className = 'detail-header';

        const label = document.createElement('div');
        label.className = 'detail-section-label';
        label.textContent = 'Reading';

        const title = document.createElement('h2');
        title.className = 'detail-title';
        title.textContent = insight.title || '(Untitled insight)';

        const metaRow = document.createElement('div');
        metaRow.className = 'detail-meta-row';

        const metaMain = document.createElement('div');
        metaMain.className = 'detail-meta-main';
        const voiceSpan = document.createElement('span');
        voiceSpan.innerHTML = `<strong>${insight.voice || 'Unknown voice'}</strong>`;
        const metaDot = document.createElement('span');
        metaDot.className = 'meta-dot';
        const dateSpan = document.createElement('span');
        dateSpan.textContent = formatDate(insight.created_at);
        metaMain.appendChild(voiceSpan);
        metaMain.appendChild(metaDot);
        metaMain.appendChild(dateSpan);

        const actions = document.createElement('div');
        actions.className = 'detail-actions';

        const focusVoiceBtn = document.createElement('button');
        focusVoiceBtn.type = 'button';
        focusVoiceBtn.className = 'detail-pill-btn';
        const focusDot = document.createElement('span');
        focusDot.className = 'dot';
        const focusLabel = document.createElement('span');
        focusLabel.textContent = 'Focus on this voice';
        focusVoiceBtn.appendChild(focusDot);
        focusVoiceBtn.appendChild(focusLabel);
        focusVoiceBtn.addEventListener('click', () => {
            selectedVoices.clear();
            if (insight.voice) {
                selectedVoices.add(insight.voice);
            }
            renderFilterChips();
            applyFilters();
        });

        actions.appendChild(focusVoiceBtn);

        metaRow.appendChild(metaMain);
        metaRow.appendChild(actions);

        const tagsRow = document.createElement('div');
        tagsRow.className = 'detail-tags-row';
        if (Array.isArray(insight.tags) && insight.tags.length > 0) {
            insight.tags.forEach(tag => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'detail-tag-link';
                const dotEl = document.createElement('span');
                dotEl.className = 'dot';
                const labelEl = document.createElement('span');
                labelEl.textContent = tag;
                btn.appendChild(dotEl);
                btn.appendChild(labelEl);
                btn.addEventListener('click', () => {
                    if (selectedTags.has(tag)) {
                        selectedTags.delete(tag);
                    } else {
                        selectedTags.add(tag);
                    }
                    renderFilterChips();
                    applyFilters();
                });
                tagsRow.appendChild(btn);
            });
        }

        header.appendChild(label);
        header.appendChild(title);
        header.appendChild(metaRow);
        header.appendChild(tagsRow);

        const layout = document.createElement('div');
        layout.className = 'detail-main-layout';

        const body = document.createElement('div');
        body.className = 'detail-body';
        body.textContent = insight.text || '';

        const relatedSection = document.createElement('section');
        relatedSection.className = 'related-section';

        const relatedHeader = document.createElement('div');
        relatedHeader.className = 'related-header';
        const relatedTitle = document.createElement('div');
        relatedTitle.className = 'related-title';
        relatedTitle.textContent = 'Related perspectives';
        const relatedHint = document.createElement('div');
        relatedHint.style.fontSize = '0.7rem';
        relatedHint.style.color = 'var(--text-softer)';
        relatedHint.textContent = 'Same voice and overlapping topics';
        relatedHeader.appendChild(relatedTitle);
        relatedHeader.appendChild(relatedHint);

        const relatedList = document.createElement('ul');
        relatedList.className = 'related-list';
        const relatedItems = getRelatedInsights(insight);
        if (relatedItems.length === 0) {
            const none = document.createElement('div');
            none.style.fontSize = '0.74rem';
            none.style.color = 'var(--text-softer)';
            none.textContent = 'No related insights yet. Explore other cards to trace shared themes.';
            relatedSection.appendChild(relatedHeader);
            relatedSection.appendChild(none);
        } else {
            relatedItems.forEach(item => {
                const li = document.createElement('li');
                li.className = 'related-item';
                const main = document.createElement('div');
                main.className = 'related-main';
                const titleText = document.createElement('span');
                titleText.className = 'related-title-text';
                titleText.textContent = item.insight.title || '(Untitled insight)';
                const meta = document.createElement('span');
                meta.className = 'related-meta';
                const shared = item.sharedTags && item.sharedTags.length > 0
                    ? `¬∑ ${item.sharedTags.slice(0, 2).join(', ')}`
                    : '';
                meta.textContent = `${item.insight.voice || 'Unknown'} ${shared}`;
                main.appendChild(titleText);
                main.appendChild(meta);

                const pill = document.createElement('span');
                pill.className = 'related-pill';
                pill.textContent = formatDate(item.insight.created_at) || 'Related';

                li.appendChild(main);
                li.appendChild(pill);

                li.addEventListener('click', () => {
                    selectInsight(item.insight.id);
                });

                relatedList.appendChild(li);
            });
            relatedSection.appendChild(relatedHeader);
            relatedSection.appendChild(relatedList);
        }

        layout.appendChild(body);
        layout.appendChild(relatedSection);

        container.appendChild(header);
        container.appendChild(layout);
    }

    async function init() {
        try {
            await store.init();
            allInsights = await store.getAll();

            const voices = [...new Set(allInsights.map(i => i.voice).filter(Boolean))].sort((a, b) =>
                a.toLowerCase().localeCompare(b.toLowerCase())
            );

            const tagsSet = new Set();
            allInsights.forEach(insight => {
                if (Array.isArray(insight.tags)) {
                    insight.tags.forEach(tag => {
                        if (tag) tagsSet.add(tag);
                    });
                }
            });
            const tags = Array.from(tagsSet).sort((a, b) =>
                a.toLowerCase().localeCompare(b.toLowerCase())
            );

            allVoices = voices;
            allTags = tags;

            setupEventHandlers();
            renderFilterChips();
            applyFilters();
        } catch (error) {
            console.error('Failed to initialize:', error);
            const list = document.getElementById('insightList');
            if (list) {
                list.innerHTML = '';
                const li = document.createElement('li');
                li.className = 'insight-empty';
                li.textContent = 'Unable to read from the CrossPerspectivesDB IndexedDB store. Open DevTools ‚Üí Console for details.';
                list.appendChild(li);
            }
            const detail = document.getElementById('detailContent');
            if (detail) {
                detail.innerHTML = '';
                const errorBox = document.createElement('div');
                errorBox.className = 'detail-empty';
                errorBox.textContent = 'The reader could not connect to the database. Please ensure CrossPerspectivesDB is populated in this browser.';
                detail.appendChild(errorBox);
            }
        }
    }

    window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
