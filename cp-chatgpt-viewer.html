<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cross Perspectives</title>
    <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --chip-bg: rgba(15,23,42,0.9);
            --chip-border: rgba(148,163,184,0.5);
            --chip-border-soft: rgba(148,163,184,0.35);
        }

        body {
            @apply bg-slate-950 text-slate-100;
        }

        .scroll-thin {
            scrollbar-width: thin;
            scrollbar-color: rgba(148,163,184,0.6) transparent;
        }

        .scroll-thin::-webkit-scrollbar {
            width: 6px;
        }

        .scroll-thin::-webkit-scrollbar-track {
            background: transparent;
        }

        .scroll-thin::-webkit-scrollbar-thumb {
            background-color: rgba(148,163,184,0.6);
            border-radius: 9999px;
        }

        .chip {
            background-color: var(--chip-bg);
            border-radius: 9999px;
            border: 1px solid var(--chip-border-soft);
            font-size: 0.75rem;
            padding: 0.25rem 0.7rem;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            color: rgb(148,163,184);
            cursor: pointer;
            white-space: nowrap;
            transition: border-color 120ms ease, background-color 120ms ease, color 120ms ease, box-shadow 120ms ease;
        }

        .chip:hover {
            border-color: rgba(148,163,184,0.8);
            color: rgb(226,232,240);
        }

        .chip-dot {
            width: 7px;
            height: 7px;
            border-radius: 9999px;
            background-color: rgba(148,163,184,0.9);
        }

        .chip-label-main {
            max-width: 140px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chip-label-count {
            font-size: 0.7rem;
            color: rgb(148,163,184);
        }

        .voice-chip {
            border-color: var(--chip-border-soft);
        }

        .voice-chip--active {
            border-color: var(--voice-color, rgb(56,189,248));
            box-shadow: 0 0 0 1px rgba(15,23,42,1);
            background-color: rgba(15,23,42,0.9);
            color: rgb(226,232,240);
        }

        .voice-chip--active .chip-dot {
            background-color: var(--voice-color, rgb(56,189,248));
        }

        .tag-chip--active {
            border-color: rgb(56,189,248);
            background-color: rgba(8,47,73,0.8);
            color: rgb(226,232,240);
        }

        .detail-body {
            white-space: pre-wrap;
        }

        .all-voices-indicator {
            transition: background-color 150ms ease, border-color 150ms ease, color 150ms ease;
        }

        .all-voices-indicator.active {
            background-color: rgba(16,185,129,0.12);
            border-color: rgb(16,185,129);
            color: rgb(209,250,229);
        }

        .all-voices-indicator.inactive {
            background-color: rgba(30,64,175,0.12);
            border-color: rgba(148,163,184,0.5);
            color: rgb(148,163,184);
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
<div class="min-h-screen flex flex-col">
    <header class="sticky top-0 z-20 border-b border-slate-800 bg-slate-900/80 backdrop-blur">
        <div class="mx-auto flex max-w-7xl items-start justify-between gap-4 px-4 py-3">
            <div class="space-y-1">
                <div class="inline-flex items-center gap-2 rounded-full border border-slate-600/70 bg-slate-900 px-2.5 py-0.5 text-[0.7rem] uppercase tracking-[0.16em] text-slate-300">
                    <span class="inline-block h-1.5 w-1.5 rounded-full bg-sky-400 shadow-[0_0_8px_rgba(56,189,248,0.9)]"></span>
                    <span>Perspective Explorer</span>
                </div>
                <div class="flex flex-wrap items-baseline gap-x-2 gap-y-1">
                    <h1 class="text-base font-semibold tracking-wide">
                        <span class="bg-gradient-to-r from-sky-400 via-fuchsia-400 to-emerald-400 bg-clip-text text-transparent">Cross Perspectives</span>
                    </h1>
                    <span class="text-[0.8rem] text-slate-400">¬∑ theological insight atlas</span>
                </div>
                <p class="max-w-xl text-[0.85rem] text-slate-400">
                    Browse voices, follow themes, and read the cross from many angles in a single, woven view.
                </p>
            </div>
            <div class="hidden items-center gap-3 text-[0.75rem] text-slate-300 sm:flex">
                <div class="inline-flex items-center gap-2 rounded-full border border-slate-700 bg-slate-900 px-2.5 py-1 shadow-sm">
                    <span class="text-slate-400">Insights</span>
                    <span id="statsTotal" class="font-semibold text-sky-400">‚Äì</span>
                </div>
                <div class="inline-flex items-center gap-2 rounded-full border border-slate-700 bg-slate-900 px-2.5 py-1 shadow-sm">
                    <span class="text-slate-400">Voices</span>
                    <span id="statsVoices" class="font-semibold text-sky-400">‚Äì</span>
                </div>
                <div class="inline-flex items-center gap-2 rounded-full border border-slate-700 bg-slate-900 px-2.5 py-1 shadow-sm">
                    <span class="text-slate-400">Topics</span>
                    <span id="statsTags" class="font-semibold text-sky-400">‚Äì</span>
                </div>
            </div>
        </div>
    </header>

    <main class="mx-auto flex w-full max-w-7xl flex-1 flex-col gap-4 px-4 py-4 lg:grid lg:grid-cols-[270px,minmax(0,1.1fr),minmax(0,1.6fr)]">
        <!-- Sidebar -->
        <aside class="flex flex-col gap-3 rounded-2xl border border-slate-800 bg-slate-950/80 p-3 shadow-lg shadow-slate-950/60 lg:row-span-2">
            <!-- Search & sort -->
            <section class="rounded-xl border border-slate-800 bg-slate-900/80 p-3 space-y-3">
                <div class="flex items-center justify-between gap-2">
                    <div class="text-[0.7rem] uppercase tracking-[0.18em] text-slate-400">Search &amp; Sort</div>
                    <span class="rounded-full border border-slate-700 bg-slate-900 px-2 py-0.5 text-[0.7rem] text-slate-400">Reader controls</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="relative flex-1">
                        <span class="pointer-events-none absolute inset-y-0 left-2 flex items-center text-xs text-slate-500">üîç</span>
                        <input id="searchInput" type="text" placeholder="Search title, text, or voice"
                               class="w-full rounded-full border border-slate-700 bg-slate-950 px-7 py-1.5 text-xs text-slate-100 placeholder:text-slate-500 focus:border-sky-400 focus:outline-none focus:ring-1 focus:ring-sky-500/60">
                    </div>
                    <button id="clearFilters" type="button"
                            class="inline-flex items-center gap-1 rounded-full border border-slate-700 bg-slate-950 px-2 py-1 text-[0.7rem] text-slate-300 hover:border-slate-200 hover:text-slate-50">
                        <span>‚úï</span>
                        <span>Clear</span>
                    </button>
                </div>
                <div class="flex items-center gap-2">
                    <label for="sortSelect" class="text-[0.7rem] text-slate-400">Order</label>
                    <select id="sortSelect"
                            class="flex-1 rounded-full border border-slate-700 bg-slate-950 px-3 py-1.5 text-xs text-slate-100 focus:border-sky-400 focus:outline-none focus:ring-1 focus:ring-sky-500/60">
                        <option value="newest">Newest first</option>
                        <option value="oldest">Oldest first</option>
                        <option value="title">By title</option>
                        <option value="voice">By voice</option>
                    </select>
                </div>
            </section>

            <!-- Voices -->
            <section class="space-y-2 rounded-xl border border-slate-800 bg-slate-900/80 p-3">
                <div class="flex items-center justify-between gap-2">
                    <div class="text-[0.7rem] uppercase tracking-[0.18em] text-slate-400">Voices</div>
                    <span class="rounded-full border border-slate-700 bg-slate-950 px-2 py-0.5 text-[0.7rem] text-slate-400">Click to focus</span>
                </div>

                <div id="allVoicesIndicator"
                     class="all-voices-indicator active mb-2 inline-flex items-center gap-2 rounded-full border px-2.5 py-1 text-[0.7rem]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                              d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293A1 1 0 006.293 10.707l2 2a1 1 0 001.414 0l4-4z"
                              clip-rule="evenodd"/>
                    </svg>
                    <span>Viewing all voices</span>
                </div>

                <div id="voiceChips" class="scroll-thin flex max-h-40 flex-wrap gap-2 overflow-y-auto"></div>
            </section>

            <!-- Topics -->
            <section class="space-y-2 rounded-xl border border-slate-800 bg-slate-900/80 p-3">
                <div class="flex items-center justify-between gap-2">
                    <div class="text-[0.7rem] uppercase tracking-[0.18em] text-slate-400">Topics</div>
                    <span class="rounded-full border border-slate-700 bg-slate-950 px-2 py-0.5 text-[0.7rem] text-slate-400">Mix &amp; match</span>
                </div>
                <div id="tagChips" class="scroll-thin flex max-h-40 flex-wrap gap-2 overflow-y-auto"></div>
            </section>

            <!-- Collection glance -->
            <section class="space-y-2 rounded-xl border border-slate-800 bg-slate-900/80 p-3">
                <div class="text-[0.7rem] uppercase tracking-[0.18em] text-slate-400">Collection glance</div>
                <div class="grid grid-cols-3 gap-2 text-[0.7rem]">
                    <div class="rounded-lg border border-slate-800 bg-slate-950 p-2">
                        <div class="text-slate-400">Visible</div>
                        <div class="flex items-baseline gap-1">
                            <span id="statsVisible" class="text-sm font-semibold text-sky-400">‚Äì</span>
                            <span class="text-[0.7rem] text-slate-500">now</span>
                        </div>
                    </div>
                    <div class="rounded-lg border border-slate-800 bg-slate-950 p-2">
                        <div class="text-slate-400">Voices</div>
                        <div class="flex items-baseline gap-1">
                            <span id="statsVoicesSmall" class="text-sm font-semibold text-sky-400">‚Äì</span>
                            <span class="text-[0.7rem] text-slate-500">distinct</span>
                        </div>
                    </div>
                    <div class="rounded-lg border border-slate-800 bg-slate-950 p-2">
                        <div class="text-slate-400">Topics</div>
                        <div class="flex items-baseline gap-1">
                            <span id="statsTagsSmall" class="text-sm font-semibold text-sky-400">‚Äì</span>
                            <span class="text-[0.7rem] text-slate-500">themes</span>
                        </div>
                    </div>
                </div>
            </section>
        </aside>

        <!-- List panel -->
        <section class="flex min-h-[12rem] flex-col rounded-2xl border border-slate-800 bg-slate-950/80 p-3 shadow-lg shadow-slate-950/60">
            <div class="mb-2 flex items-center justify-between gap-2">
                <div>
                    <div class="text-[0.7rem] uppercase tracking-[0.18em] text-slate-400">Insights</div>
                    <p class="text-[0.75rem] text-slate-400">Click a card to open the full perspective.</p>
                </div>
                <div class="inline-flex items-center gap-2 rounded-full border border-slate-700 bg-slate-900 px-2.5 py-1 text-[0.7rem] text-slate-300">
                    <span>Showing</span>
                    <span id="listCount" class="font-semibold text-slate-50">‚Äì</span>
                </div>
            </div>
            <ul id="insightList"
                class="scroll-thin mt-1 flex-1 list-none space-y-1 overflow-y-auto rounded-xl border border-slate-900 bg-slate-950/80 p-1 text-sm">
                <li class="px-3 py-4 text-center text-xs text-slate-400">Loading insights‚Ä¶</li>
            </ul>
        </section>

        <!-- Detail panel -->
        <section class="flex min-h-[12rem] flex-col rounded-2xl border border-indigo-700/70 bg-slate-950/80 p-3 shadow-lg shadow-slate-950/60">
            <div id="detailContent" class="flex flex-1 items-center justify-center px-4 py-6 text-center text-[0.85rem] text-slate-400">
                Choose a voice or topic on the left, then select an insight to begin reading.
            </div>
        </section>
    </main>
</div>

<script src="cp-config.js"></script>
<script src="cp-store.js"></script>
<script src="cp-renderers.js"></script>

<script>
    const colorPalette = [
        '#10b981', '#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b',
        '#ef4444', '#06b6d4', '#84cc16', '#f97316', '#6366f1'
    ];

    function getVoiceColor(voice) {
        const voices = (typeof CONFIG !== 'undefined' && Array.isArray(CONFIG.VOICES)) ? CONFIG.VOICES : [];
        const index = voices.indexOf(voice);
        if (index !== -1) {
            return colorPalette[index % colorPalette.length];
        }
        if (!voice) return colorPalette[0];
        let hash = 0;
        for (let i = 0; i < voice.length; i++) {
            hash = (hash + voice.charCodeAt(i)) % colorPalette.length;
        }
        return colorPalette[hash];
    }

    let allInsights = [];
    let filteredInsights = [];
    let allVoices = [];
    let allTags = [];
    const selectedVoices = new Set();
    const selectedTags = new Set();
    let searchQuery = '';
    let sortMode = 'newest';
    let selectedInsightId = null;

    function truncate(text, maxLength) {
        if (!text) return '';
        if (text.length <= maxLength) return text;
        return text.slice(0, maxLength - 1) + '‚Ä¶';
    }

    function formatDate(isoString) {
        if (!isoString) return '';
        const date = new Date(isoString);
        if (isNaN(date.getTime())) return '';
        return date.toLocaleDateString(undefined, {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    }

    function setupEventHandlers() {
        const searchInput = document.getElementById('searchInput');
        const sortSelect = document.getElementById('sortSelect');
        const clearBtn = document.getElementById('clearFilters');

        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                searchQuery = e.target.value || '';
                applyFilters();
            });
        }

        if (sortSelect) {
            sortSelect.addEventListener('change', (e) => {
                sortMode = e.target.value;
                applyFilters();
            });
        }

        if (clearBtn) {
            clearBtn.addEventListener('click', () => {
                selectedVoices.clear();
                selectedTags.clear();
                searchQuery = '';
                sortMode = 'newest';
                selectedInsightId = null;

                if (searchInput) searchInput.value = '';
                if (sortSelect) sortSelect.value = 'newest';

                renderFilterChips();
                applyFilters();
                renderDetail(null);
            });
        }
    }

    function updateAllVoicesIndicator() {
        const indicator = document.getElementById('allVoicesIndicator');
        if (!indicator) return;
        if (selectedVoices.size === 0) {
            indicator.classList.add('active');
            indicator.classList.remove('inactive');
        } else {
            indicator.classList.remove('active');
            indicator.classList.add('inactive');
        }
    }

    function renderFilterChips() {
        const voiceContainer = document.getElementById('voiceChips');
        const tagContainer = document.getElementById('tagChips');

        if (voiceContainer) {
            voiceContainer.innerHTML = '';
            allVoices.forEach((voice) => {
                const count = allInsights.filter(i => i.voice === voice).length;
                const color = getVoiceColor(voice);

                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'chip voice-chip flex items-center';
                if (selectedVoices.has(voice)) {
                    btn.classList.add('voice-chip--active');
                }
                btn.style.setProperty('--voice-color', color);

                const dot = document.createElement('span');
                dot.className = 'chip-dot';

                const label = document.createElement('span');
                label.className = 'chip-label-main';
                label.textContent = voice || 'Unknown';

                const countSpan = document.createElement('span');
                countSpan.className = 'chip-label-count';
                countSpan.textContent = count;

                btn.appendChild(dot);
                btn.appendChild(label);
                btn.appendChild(countSpan);

                btn.addEventListener('click', () => {
                    if (selectedVoices.has(voice)) {
                        selectedVoices.delete(voice);
                    } else {
                        selectedVoices.add(voice);
                    }
                    renderFilterChips();
                    applyFilters();
                });

                voiceContainer.appendChild(btn);
            });
        }

        if (tagContainer) {
            tagContainer.innerHTML = '';
            allTags.forEach((tag) => {
                const count = allInsights.filter(i =>
                    Array.isArray(i.tags) && i.tags.includes(tag)
                ).length;

                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'chip flex items-center';
                if (selectedTags.has(tag)) {
                    btn.classList.add('tag-chip--active');
                }

                const dot = document.createElement('span');
                dot.className = 'chip-dot';

                const label = document.createElement('span');
                label.className = 'chip-label-main';
                label.textContent = tag;

                const countSpan = document.createElement('span');
                countSpan.className = 'chip-label-count';
                countSpan.textContent = count;

                btn.appendChild(dot);
                btn.appendChild(label);
                btn.appendChild(countSpan);

                btn.addEventListener('click', () => {
                    if (selectedTags.has(tag)) {
                        selectedTags.delete(tag);
                    } else {
                        selectedTags.add(tag);
                    }
                    renderFilterChips();
                    applyFilters();
                });

                tagContainer.appendChild(btn);
            });
        }

        updateAllVoicesIndicator();
    }

    function applyFilters() {
        let result = allInsights.slice();

        if (selectedVoices.size > 0) {
            result = result.filter(insight => selectedVoices.has(insight.voice));
        }

        if (selectedTags.size > 0) {
            result = result.filter(insight =>
                Array.isArray(insight.tags) &&
                insight.tags.some(tag => selectedTags.has(tag))
            );
        }

        if (searchQuery && searchQuery.trim().length > 0) {
            const q = searchQuery.toLowerCase();
            result = result.filter(insight => {
                const text = `${insight.title || ''} ${insight.text || ''} ${insight.voice || ''}`.toLowerCase();
                return text.includes(q);
            });
        }

        switch (sortMode) {
            case 'oldest':
                result.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                break;
            case 'title':
                result.sort((a, b) => {
                    const ta = (a.title || '').toLowerCase();
                    const tb = (b.title || '').toLowerCase();
                    if (ta < tb) return -1;
                    if (ta > tb) return 1;
                    return new Date(b.created_at) - new Date(a.created_at);
                });
                break;
            case 'voice':
                result.sort((a, b) => {
                    const va = (a.voice || '').toLowerCase();
                    const vb = (b.voice || '').toLowerCase();
                    if (va < vb) return -1;
                    if (va > vb) return 1;
                    return new Date(b.created_at) - new Date(a.created_at);
                });
                break;
            case 'newest':
            default:
                result.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                break;
        }

        filteredInsights = result;
        renderList();
        renderStats();

        if (selectedInsightId) {
            const stillVisible = filteredInsights.some(i => i.id === selectedInsightId);
            if (!stillVisible) {
                selectedInsightId = null;
                renderDetail(null);
            } else {
                highlightSelectedCard();
            }
        }
    }

    function renderStats() {
        const totalEl = document.getElementById('statsTotal');
        const voicesEl = document.getElementById('statsVoices');
        const tagsEl = document.getElementById('statsTags');
        const visibleEl = document.getElementById('statsVisible');
        const voicesSmallEl = document.getElementById('statsVoicesSmall');
        const tagsSmallEl = document.getElementById('statsTagsSmall');
        const listCountEl = document.getElementById('listCount');

        const total = allInsights.length;
        const totalVoices = allVoices.length;
        const totalTags = allTags.length;
        const visible = filteredInsights.length;

        if (totalEl) totalEl.textContent = total || '0';
        if (voicesEl) voicesEl.textContent = totalVoices || '0';
        if (tagsEl) tagsEl.textContent = totalTags || '0';
        if (visibleEl) visibleEl.textContent = visible || '0';
        if (voicesSmallEl) voicesSmallEl.textContent = totalVoices || '0';
        if (tagsSmallEl) tagsSmallEl.textContent = totalTags || '0';
        if (listCountEl) listCountEl.textContent = visible || '0';
    }

    function renderList() {
        const list = document.getElementById('insightList');
        if (!list) return;
        list.innerHTML = '';

        if (!filteredInsights.length) {
            const li = document.createElement('li');
            li.className = 'px-3 py-4 text-center text-xs text-slate-400';
            li.textContent = 'No insights match your current filters. Try clearing filters or changing search.';
            list.appendChild(li);
            return;
        }

        filteredInsights.forEach((insight) => {
            const li = document.createElement('li');
            const card = document.createElement('article');
            card.className = 'insight-card rounded-xl border border-slate-900 bg-slate-950/80 px-3 py-2.5 text-xs text-slate-200 hover:border-sky-500/80 hover:bg-slate-900/80 cursor-pointer transition';
            card.dataset.id = String(insight.id);

            const titleRow = document.createElement('div');
            titleRow.className = 'mb-1 flex items-start justify-between gap-2';

            const titleEl = document.createElement('h3');
            titleEl.className = 'text-[0.85rem] font-semibold text-slate-50';
            titleEl.textContent = insight.title || '(Untitled insight)';

            const voiceColor = getVoiceColor(insight.voice);
            const voiceDot = document.createElement('span');
            voiceDot.className = 'mt-1 inline-flex h-2 w-2 flex-shrink-0 rounded-full';
            voiceDot.style.backgroundColor = voiceColor;

            titleRow.appendChild(titleEl);
            titleRow.appendChild(voiceDot);

            const metaRow = document.createElement('div');
            metaRow.className = 'mb-1 flex items-center gap-2 text-[0.7rem] text-slate-400';
            const voiceSpan = document.createElement('span');
            voiceSpan.textContent = insight.voice || 'Unknown voice';
            const dot = document.createElement('span');
            dot.className = 'h-1 w-1 rounded-full bg-slate-500';
            const dateSpan = document.createElement('span');
            dateSpan.textContent = formatDate(insight.created_at);
            metaRow.appendChild(voiceSpan);
            metaRow.appendChild(dot);
            metaRow.appendChild(dateSpan);

            const textEl = document.createElement('p');
            textEl.className = 'mb-1 text-[0.75rem] text-slate-300';
            textEl.textContent = truncate(insight.text || '', 200);

            const tagsRow = document.createElement('div');
            tagsRow.className = 'flex flex-wrap gap-1';
            if (Array.isArray(insight.tags) && insight.tags.length > 0) {
                insight.tags.forEach((tag) => {
                    const span = document.createElement('span');
                    span.className = 'rounded-full border border-slate-700 bg-slate-950 px-2 py-0.5 text-[0.65rem] text-slate-300';
                    span.textContent = tag;
                    tagsRow.appendChild(span);
                });
            }

            card.appendChild(titleRow);
            card.appendChild(metaRow);
            card.appendChild(textEl);
            card.appendChild(tagsRow);

            card.addEventListener('click', () => {
                selectInsight(insight.id);
            });

            li.appendChild(card);
            list.appendChild(li);
        });

        highlightSelectedCard();
    }

    function selectInsight(id) {
        selectedInsightId = id;
        const insight = allInsights.find(i => i.id === id);
        renderDetail(insight);
        highlightSelectedCard();
    }

    function highlightSelectedCard() {
        const cards = document.querySelectorAll('.insight-card');
        cards.forEach(card => {
            if (String(card.dataset.id) === String(selectedInsightId)) {
                card.classList.add('border-sky-500', 'bg-slate-900');
            } else {
                card.classList.remove('border-sky-500', 'bg-slate-900');
            }
        });
    }

    function getRelatedInsights(insight, maxCount = 6) {
        if (!insight) return [];
        const currentId = insight.id;
        const baseTags = Array.isArray(insight.tags) ? insight.tags : [];

        const scored = allInsights
            .filter(other => other.id !== currentId)
            .map(other => {
                let score = 0;
                if (other.voice === insight.voice) score += 2;
                const otherTags = Array.isArray(other.tags) ? other.tags : [];
                const sharedTags = otherTags.filter(t => baseTags.includes(t));
                score += sharedTags.length;
                return { insight: other, score, sharedTags };
            })
            .filter(item => item.score > 0);

        scored.sort((a, b) => {
            if (b.score !== a.score) return b.score - a.score;
            return new Date(b.insight.created_at) - new Date(a.insight.created_at);
        });

        return scored.slice(0, maxCount);
    }

    function renderDetail(insight) {
        const container = document.getElementById('detailContent');
        if (!container) return;
        container.innerHTML = '';

        if (!insight) {
            const empty = document.createElement('div');
            empty.className = 'flex flex-1 items-center justify-center px-4 py-6 text-center text-[0.85rem] text-slate-400';
            empty.textContent = 'Select an insight from the list to see its full perspective.';
            container.appendChild(empty);
            return;
        }

        const wrapper = document.createElement('div');
        wrapper.className = 'flex h-full flex-col gap-3';

        const header = document.createElement('div');
        header.className = 'space-y-1';

        const label = document.createElement('div');
        label.className = 'text-[0.7rem] uppercase tracking-[0.18em] text-slate-400';
        label.textContent = 'Reading';

        const title = document.createElement('h2');
        title.className = 'text-sm font-semibold text-slate-50';
        title.textContent = insight.title || '(Untitled insight)';

        const metaRow = document.createElement('div');
        metaRow.className = 'flex flex-wrap items-center justify-between gap-2 text-[0.75rem] text-slate-300';

        const leftMeta = document.createElement('div');
        leftMeta.className = 'flex items-center gap-2';

        const voiceColor = getVoiceColor(insight.voice);
        const voiceDot = document.createElement('span');
        voiceDot.className = 'inline-flex h-2.5 w-2.5 rounded-full';
        voiceDot.style.backgroundColor = voiceColor;

        const voiceSpan = document.createElement('span');
        voiceSpan.className = 'font-medium';
        voiceSpan.textContent = insight.voice || 'Unknown voice';

        const dot = document.createElement('span');
        dot.className = 'h-1 w-1 rounded-full bg-slate-500';

        const dateSpan = document.createElement('span');
        dateSpan.className = 'text-slate-400';
        dateSpan.textContent = formatDate(insight.created_at);

        leftMeta.appendChild(voiceDot);
        leftMeta.appendChild(voiceSpan);
        leftMeta.appendChild(dot);
        leftMeta.appendChild(dateSpan);

        const actions = document.createElement('div');
        actions.className = 'flex items-center gap-2';

        const focusVoiceBtn = document.createElement('button');
        focusVoiceBtn.type = 'button';
        focusVoiceBtn.className = 'inline-flex items-center gap-2 rounded-full border border-slate-700 bg-slate-950 px-3 py-1 text-[0.7rem] text-slate-200 hover:border-sky-400';
        const focusDot = document.createElement('span');
        focusDot.className = 'inline-flex h-2 w-2 rounded-full';
        focusDot.style.backgroundColor = voiceColor;
        const focusLabel = document.createElement('span');
        focusLabel.textContent = 'Focus on this voice';
        focusVoiceBtn.appendChild(focusDot);
        focusVoiceBtn.appendChild(focusLabel);
        focusVoiceBtn.addEventListener('click', () => {
            selectedVoices.clear();
            if (insight.voice) selectedVoices.add(insight.voice);
            renderFilterChips();
            applyFilters();
        });

        actions.appendChild(focusVoiceBtn);

        metaRow.appendChild(leftMeta);
        metaRow.appendChild(actions);

        const tagsRow = document.createElement('div');
        tagsRow.className = 'flex flex-wrap gap-1';
        if (Array.isArray(insight.tags) && insight.tags.length > 0) {
            insight.tags.forEach(tag => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'inline-flex items-center gap-1 rounded-full border border-slate-700 bg-slate-950 px-2 py-0.5 text-[0.7rem] text-slate-300 hover:border-sky-400';
                const dotEl = document.createElement('span');
                dotEl.className = 'inline-flex h-1.5 w-1.5 rounded-full bg-indigo-400';
                const labelEl = document.createElement('span');
                labelEl.textContent = tag;
                btn.appendChild(dotEl);
                btn.appendChild(labelEl);
                btn.addEventListener('click', () => {
                    if (selectedTags.has(tag)) {
                        selectedTags.delete(tag);
                    } else {
                        selectedTags.add(tag);
                    }
                    renderFilterChips();
                    applyFilters();
                });
                tagsRow.appendChild(btn);
            });
        }

        header.appendChild(label);
        header.appendChild(title);
        header.appendChild(metaRow);
        header.appendChild(tagsRow);

        const layout = document.createElement('div');
        layout.className = 'flex min-h-0 flex-1 flex-col gap-3 lg:grid lg:grid-cols-[minmax(0,1.9fr),minmax(240px,1.2fr)]';

        const body = document.createElement('div');
        body.className = 'detail-body scroll-thin rounded-xl border border-slate-900 bg-slate-950/90 p-3 text-[0.85rem] leading-relaxed text-slate-100';
        body.textContent = insight.text || '';

        const relatedSection = document.createElement('section');
        relatedSection.className = 'flex min-h-0 flex-col gap-2 rounded-xl border border-slate-900 bg-slate-950/90 p-3 text-[0.8rem]';

        const relatedHeader = document.createElement('div');
        relatedHeader.className = 'flex items-center justify-between gap-2';
        const relatedTitle = document.createElement('div');
        relatedTitle.className = 'text-[0.7rem] uppercase tracking-[0.16em] text-slate-400';
        relatedTitle.textContent = 'Related perspectives';
        const relatedHint = document.createElement('div');
        relatedHint.className = 'text-[0.7rem] text-slate-500';
        relatedHint.textContent = 'Same voice and overlapping topics';
        relatedHeader.appendChild(relatedTitle);
        relatedHeader.appendChild(relatedHint);

        const relatedList = document.createElement('ul');
        relatedList.className = 'scroll-thin mt-1 flex-1 list-none space-y-1 overflow-y-auto';

        const relatedItems = getRelatedInsights(insight);
        if (relatedItems.length === 0) {
            const none = document.createElement('div');
            none.className = 'text-[0.75rem] text-slate-500';
            none.textContent = 'No related insights yet. Explore other cards to trace shared themes.';
            relatedSection.appendChild(relatedHeader);
            relatedSection.appendChild(none);
        } else {
            relatedItems.forEach(item => {
                const li = document.createElement('li');
                li.className = 'cursor-pointer rounded-full border border-slate-800 bg-slate-950 px-3 py-1.5 text-[0.75rem] text-slate-200 hover:border-sky-400 flex items-center justify-between gap-2';

                const main = document.createElement('div');
                main.className = 'flex min-w-0 flex-col';
                const titleText = document.createElement('span');
                titleText.className = 'truncate';
                titleText.textContent = item.insight.title || '(Untitled insight)';
                const meta = document.createElement('span');
                meta.className = 'text-[0.7rem] text-slate-400';
                const shared = item.sharedTags && item.sharedTags.length > 0
                    ? ` ¬∑ ${item.sharedTags.slice(0, 2).join(', ')}`
                    : '';
                meta.textContent = `${item.insight.voice || 'Unknown'}${shared}`;
                main.appendChild(titleText);
                main.appendChild(meta);

                const pill = document.createElement('span');
                pill.className = 'whitespace-nowrap rounded-full border border-sky-500/70 bg-sky-500/10 px-2 py-0.5 text-[0.7rem] text-sky-300';
                pill.textContent = formatDate(item.insight.created_at) || 'Related';

                li.appendChild(main);
                li.appendChild(pill);

                li.addEventListener('click', () => {
                    selectInsight(item.insight.id);
                });

                relatedList.appendChild(li);
            });
            relatedSection.appendChild(relatedHeader);
            relatedSection.appendChild(relatedList);
        }

        layout.appendChild(body);
        layout.appendChild(relatedSection);

        wrapper.appendChild(header);
        wrapper.appendChild(layout);

        container.appendChild(wrapper);
    }

    async function init() {
        try {
            if (!window.store || !store.init) {
                console.error('CrossStore (store) not found. Ensure cp-store.js is loaded.');
                return;
            }

            await store.init();
            allInsights = await store.getAll();

            const voices = [...new Set(allInsights.map(i => i.voice).filter(Boolean))]
                .sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));
            const tagsSet = new Set();
            allInsights.forEach(insight => {
                if (Array.isArray(insight.tags)) {
                    insight.tags.forEach(tag => {
                        if (tag) tagsSet.add(tag);
                    });
                }
            });
            const tags = Array.from(tagsSet).sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));

            allVoices = voices;
            allTags = tags;

            setupEventHandlers();
            renderFilterChips();
            applyFilters();
            renderDetail(null);
        } catch (error) {
            console.error('Failed to initialize:', error);
            const list = document.getElementById('insightList');
            if (list) {
                list.innerHTML = '';
                const li = document.createElement('li');
                li.className = 'px-3 py-4 text-center text-xs text-red-400';
                li.textContent = 'Unable to read from the CrossPerspectivesDB IndexedDB store. Open DevTools ‚Üí Console for details.';
                list.appendChild(li);
            }
            const detail = document.getElementById('detailContent');
            if (detail) {
                detail.innerHTML = '';
                const errorBox = document.createElement('div');
                errorBox.className = 'flex flex-1 items-center justify-center px-4 py-6 text-center text-[0.85rem] text-red-400';
                errorBox.textContent = 'The reader could not connect to the database. Please ensure CrossPerspectivesDB is populated in this browser.';
                detail.appendChild(errorBox);
            }
        }
    }

    window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
