<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Reader | Cross Perspectives</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;1,400&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-serif { font-family: 'Crimson Pro', serif; }
        
        /* ProjectDeck-style Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; } 
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body class="bg-[#0B1120] text-slate-300 h-screen flex flex-col overflow-hidden selection:bg-emerald-900 selection:text-white">

    <!-- HEADER -->
    <header class="flex-shrink-0 bg-[#0F172A]/80 backdrop-blur border-b border-slate-800/60 px-8 py-4 z-10">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            
            <!-- Branding & Navigation -->
            <div class="flex items-baseline gap-6">
                <h1 class="text-xl font-bold text-emerald-400 tracking-tight">Cross Perspectives</h1>
                <a href="cp-hub.html" class="flex items-center gap-2 text-[10px] font-bold text-slate-500 hover:text-emerald-400 transition-colors uppercase tracking-widest">
                    <span>←</span> Studio Hub
                </a>
            </div>

            <!-- Voice Dropdown -->
            <div class="relative group min-w-[240px]">
                <select id="voice-select" onchange="app.filterBy(this.value)" 
                    class="appearance-none w-full bg-[#1E293B] border border-slate-700 text-slate-200 text-sm font-medium rounded-lg pl-4 pr-10 py-2.5 focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 transition-all cursor-pointer hover:border-slate-600 shadow-lg shadow-black/20">
                    <option value="">All Perspectives</option>
                    <!-- Options injected by JS from database -->
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-400 group-hover:text-emerald-400 transition-colors">
                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                </div>
            </div>

        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-y-auto" id="scroll-container">
        <!-- Header Info -->
        <div class="max-w-5xl mx-auto px-8 pt-8 pb-4 flex justify-between items-end border-b border-slate-800/40">
            <h2 id="view-title" class="text-2xl text-slate-100 font-semibold font-serif italic">Library Overview</h2>
            <div class="text-xs text-slate-500 font-mono" id="status-indicator">Loading Data...</div>
        </div>

        <!-- Grid -->
        <div id="grid" class="max-w-5xl mx-auto p-8 space-y-8 pb-32"></div>
    </main>

    <!-- DEPENDENCIES -->
    <script src="cp-config.js"></script>
    <script src="cp-store.js"></script>
    <script src="cp-renderers.js"></script>

    <script>
        const app = {
            active: null,

            async init() {
                await store.init();
                
                // Get total count and update status
                const total = await store.db.insights.count();
                document.getElementById('status-indicator').textContent = 
                    total > 0 ? `${total} insights loaded` : "Database empty";

                // Populate dropdown from database voices
                await this.renderDropdown();
                
                // Render content
                this.render();
            },

            async renderDropdown() {
                const select = document.getElementById('voice-select');
                
                // Get unique voices from database, sorted alphabetically
                const voices = await store.db.insights
                    .orderBy('voice')
                    .uniqueKeys();
                
                voices.sort();
                
                // Add each voice as an option
                voices.forEach(v => {
                    const option = document.createElement('option');
                    option.value = v;
                    option.textContent = v;
                    select.appendChild(option);
                });
            },

            async render() {
                const data = this.active ? await store.getByVoice(this.active) : await store.getAll();
                const grid = document.getElementById('grid');

                // Update Title
                document.getElementById('view-title').innerText = this.active || "All Perspectives";

                if (data.length === 0) {
                    grid.innerHTML = this.renderEmptyState();
                    return;
                }

                // Check if Renderers object exists (from cp-renderers.js), otherwise use local fallback
                if (typeof Renderers !== 'undefined' && Renderers.insightCard) {
                    grid.innerHTML = data.map(Renderers.insightCard).join('');
                } else {
                    grid.innerHTML = data.map(item => this.localRenderCard(item)).join('');
                }
            },

            // Fallback renderer if cp-renderers.js is missing or incompatible
            localRenderCard(i) {
                return `
                <div class="bg-[#151F32] border border-slate-700/50 rounded-xl p-8 hover:border-slate-600 transition-colors shadow-sm group">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <div class="flex items-center gap-3 mb-2">
                                <span class="text-[11px] font-bold uppercase tracking-widest text-emerald-500/90 bg-emerald-500/10 px-2 py-1 rounded">
                                    ${i.voice}
                                </span>
                                <span class="text-[11px] font-mono text-slate-500">
                                    ${new Date(i.created_at).toLocaleDateString()}
                                </span>
                            </div>
                            <h3 class="text-2xl font-bold text-slate-100 group-hover:text-emerald-400 transition-colors font-serif">${i.title}</h3>
                        </div>
                    </div>
                    <p class="font-serif text-[18px] leading-relaxed text-slate-300 mb-6 border-l-2 border-slate-800 pl-4 group-hover:border-emerald-500/30 transition-colors">
                        ${i.text}
                    </p>
                    <div class="flex flex-wrap gap-2">
                        ${(i.tags || []).map(t => `
                            <span class="text-[10px] uppercase font-bold tracking-wide px-2.5 py-1 rounded-md bg-[#0B1120] border border-slate-700 text-slate-400 group-hover:text-slate-300 group-hover:border-slate-600 transition-colors">
                                ${t}
                            </span>
                        `).join('')}
                    </div>
                </div>`;
            },

            renderEmptyState() {
                return `
                <div class="flex flex-col items-center justify-center py-20 border-2 border-dashed border-slate-800 rounded-xl bg-slate-900/20">
                    <div class="text-slate-600 mb-2 text-4xl">∅</div>
                    <p class="text-slate-500 font-medium text-sm">No insights found.</p>
                    <a href="cp-hub.html" class="mt-4 text-xs text-emerald-400 hover:text-emerald-300 transition-colors">
                        → Add content in Studio Hub
                    </a>
                </div>`;
            },

            filterBy(val) {
                this.active = val;
                this.render();
                document.getElementById('scroll-container').scrollTop = 0;
            }
        };

        app.init();
    </script>
</body>
</html>
